<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.dianrong.common.uniauth.server.data.mapper.UserExtendValMapper">
  <select id="selectByUserIdAndCode" resultType="com.dianrong.common.uniauth.server.data.entity.ext.UserExtendValExt" 
  	parameterType="map">
  	SELECT * FROM(
		SELECT t2.id id,t2.user_id userId,t1.extend_id extendId,t2.value_ value,t2.status status,
			t1.extend_code extendCode,t1.extend_description extendDescription FROM (
				SELECT id extend_id,code extend_code,description extend_description FROM user_extend     
					WHERE 1=1  
				  	<if test="extendCode!=null and extendCode!=''">
				  		AND `code` LIKE #{extendCode, jdbcType=VARCHAR}
				  	</if>      
		) t1  LEFT JOIN    (
			SELECT id,user_id,value_,`status`,extend_id FROM user_extend_val WHERE id in(
				SELECT MAX(id) FROM user_extend_val  GROUP BY user_id,extend_id  HAVING user_id=#{userId} 
			)
		)t2   ON  t1.extend_id=t2.extend_id
	) tt1  ORDER BY userId DESC,id DESC 
    <if test="pageNumber !=0 and pageSize!=0">
      limit ${pageNumber},${pageSize}
    </if>
  </select>
  
  <select id="countByCode" parameterType="map" resultType="int">
  	SELECT count(*) extend_description FROM user_extend WHERE 1=1 
  	<if test="extendCode!=null and extendCode!=''">
  		AND `code` LIKE #{extendCode, jdbcType=VARCHAR}
  	</if>
  </select>
</mapper>